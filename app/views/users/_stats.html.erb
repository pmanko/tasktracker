<% viewable_projects = current_user.all_viewable_projects.where( id: user.all_projects.pluck(:id) ) %>

<% all_tasks = Sticky.current.where( project_id: viewable_projects.pluck(:id), owner_id: [user.id, nil] ) %>
<% all_tasks_due_before_today = all_tasks.due_date_before( Date.yesterday ).count %>
<% all_completed_tasks_due_before_today = all_tasks.due_date_before( Date.yesterday ).where( completed: true ).count %>

<% percent = 0 %>
<% percent = (all_completed_tasks_due_before_today * 100 / all_tasks_due_before_today rescue 0) %>
<% status = "default" %>
<% status = "danger" if percent >= 1 %>
<% status = "warning" if percent >= 80 %>
<% status = "success" if percent >= 90 %>

<div class="page-header">
  <h2>
    <div class="pull-right"><span class="label label-<%= status %>"><%= percent %> %</span> past due tasks completed</div>
    <%= current_user == user ? 'My Stats' : "#{user.first_name}'s Stats" %>
  </h2>
</div>

<% tag_names = all_tasks.collect{|s| s.tags.pluck(:name)}.flatten.uniq %>
<% if tag_names.size > 0 %>
  <h3>
    By Tags
  </h3>

  <% tag_array = [] %>

  <% tag_names.each do |tag_name| %>
    <% tag = user.all_viewable_tags.where( name: tag_name ).first %>
    <% tag_count = all_tasks.with_tag( Tag.where(name: tag_name).pluck(:id) ).count %>
    <% complete_count = all_tasks.with_tag( Tag.where(name: tag_name).pluck(:id) ).where( completed: true ).count %>
    <% incomplete_count = all_tasks.with_tag( Tag.where(name: tag_name).pluck(:id) ).where( completed: false ).count %>
    <% tag_array << [tag, tag_count, complete_count, incomplete_count] %>
  <% end %>

  <% tag_array.sort!{ |a,b| b[1] <=> a[1] } %>
  <% tag_max_count = (tag_array.first[1] rescue 0) %>


  <% tag_array.each do |tag, tag_count, complete_count, incomplete_count| %>
    <% tag_count %>
    <% tag_max_count %>
    <% percent = (tag_count * 100 / tag_max_count rescue 0) %>
    <% complete_percent = (complete_count * 100.0 / tag_max_count rescue 0) %>
    <% incomplete_percent = (incomplete_count * 100.0 / tag_max_count rescue 0) %>
    <% status = "default" %>
    <% status = "danger" if percent >= 1 %>
    <% status = "warning" if percent >= 70 %>
    <% status = "success" if percent >= 90 %>
    <div class="row">
      <div class="col-xs-4">
        <%= @tag = tag; render partial: 'tags/show' %>
        <%= link_to tag_count, tasks_path( tags: tag.name, owners: user.name ), target: '_blank' %>
      </div>
      <div class="col-xs-8">
        <div class="progress progress-striped active">
          <div class="progress-bar" style="width: <%= complete_percent %>%">
            <span class="sr-only"><%= complete_percent %>% Complete</span>
          </div>
          <div class="progress-bar progress-bar-default" style="width: <%= incomplete_percent %>%">
            <span class="sr-only"><%= incomplete_percent %>% Incomplete</span>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<% if viewable_projects.size > 0 %>
  <h3>By Project</h3>

  <% project_array = [] %>

  <% viewable_projects.each_with_index do |project| %>
    <% tasks = project.stickies.where(owner_id: [user.id, nil]) %>
    <% overall_count = tasks.count %>
    <% complete_count = tasks.where( completed: true ).count %>
    <% incomplete_count = tasks.where( completed: false ).count %>
    <% project_array << [project, overall_count, complete_count, incomplete_count] %>
  <% end %>

  <% project_array.sort!{|a,b| [b[3], b[2]] <=> [a[3], a[2]]} %>

  <% project_array.each do |project, overall_count, complete_count, incomplete_count| %>
    <% percent = 0 %>
    <% percent = (complete_count * 100 / overall_count rescue 0) %>
    <% status = "default" %>
    <% status = "danger" if percent >= 1 %>
    <% status = "warning" if percent >= 70 %>
    <% status = "success" if percent >= 90 %>
    <div class="panel panel-default">
      <div class="panel-heading">
        <span class="label label-<%= status %> pull-right"><%= percent %> %</span>
        <h3 class="panel-title">
          <%= project.name %>
        </h3>
      </div>
      <div class="panel-body">
        <table class="table">
          <thead>
            <tr>
              <th>Incomplete</th>
              <th>Complete</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><% if incomplete_count > 0 %><%= incomplete_count %><% else %><span class="text-muted">-</span><% end %></td>
              <td><% if complete_count > 0 %><%= complete_count %><% else %><span class="text-muted">-</span><% end %></td>
              <td><%= link_to overall_count, tasks_path( project_ids: project.id, owners: user.name ), target: '_blank' %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
<% end %>
